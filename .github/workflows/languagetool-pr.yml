name: LanguageTool (PR review)

on:
  # Run once when the PR is opened/re-opened.
  pull_request_target:
    types: [opened, reopened, labeled]

  # Allow maintainers to rerun by commenting "/languagetool"
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: languagetool-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

env:
  LT_LANGUAGE: en-US
  RERUN_LABEL: languagetool:run

jobs:
  # Comment command -> adds a label -> label event triggers the real run
  rerun_on_comment:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/languagetool') &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    steps:
      - name: Add rerun label to PR
        uses: actions/github-script@v7
        with:
          script: |
            const label = process.env.RERUN_LABEL;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number; // PR number for issue_comment

            // Ensure label exists (create if missing)
            try {
              await github.rest.issues.getLabel({ owner, repo, name: label });
            } catch (e) {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: label,
                color: '0e8a16',
                description: 'Rerun LanguageTool on this PR'
              });
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: [label]
            });

  languagetool:
    if: |
      github.event_name == 'pull_request_target' &&
      (
        github.event.action == 'opened' ||
        github.event.action == 'reopened' ||
        (github.event.action == 'labeled' && github.event.label.name == 'languagetool:run')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR (head SHA)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Build LanguageTool server image with custom dictionary
        shell: bash
        run: |
          set -euo pipefail

          WORDS_DIR=".github/languagetool"
          SPELLING_FILE="$WORDS_DIR/spelling.en.txt"
          IGNORE_FILE="$WORDS_DIR/ignore.en.txt"

          mkdir -p "$WORDS_DIR"
          test -f "$SPELLING_FILE" || : > "$SPELLING_FILE"
          test -f "$IGNORE_FILE"   || : > "$IGNORE_FILE"

          # Safety cap (avoid someone committing a gigantic word list)
          head -n 2000 "$SPELLING_FILE" > /tmp/spelling_additions.txt
          head -n 2000 "$IGNORE_FILE"   > /tmp/ignore_additions.txt

          mkdir -p /tmp/lt
          cp /tmp/spelling_additions.txt /tmp/lt/spelling_additions.txt
          cp /tmp/ignore_additions.txt   /tmp/lt/ignore_additions.txt

          cat > /tmp/lt/Dockerfile <<'EOF'
          FROM erikvl87/languagetool:latest
          USER root
          COPY spelling_additions.txt /tmp/spelling_additions.txt
          COPY ignore_additions.txt /tmp/ignore_additions.txt
          RUN set -e; \
              if [ -s /tmp/spelling_additions.txt ]; then (echo; cat /tmp/spelling_additions.txt) >> org/languagetool/resource/en/hunspell/spelling.txt; fi; \
              if [ -s /tmp/ignore_additions.txt ]; then (echo; cat /tmp/ignore_additions.txt) >> org/languagetool/resource/en/hunspell/ignore.txt; fi
          USER languagetool
          EOF

          docker build -t lt-custom /tmp/lt

      - name: Start LanguageTool server
        shell: bash
        run: |
          set -euo pipefail
          docker run -d --name languagetool -p 8010:8010 lt-custom

          # Wait until the API is up
          for i in {1..60}; do
            if curl -fsS http://127.0.0.1:8010/v2/languages >/dev/null; then
              exit 0
            fi
            sleep 1
          done

          echo "LanguageTool server did not start in time" >&2
          docker logs languagetool || true
          exit 1

      - name: Run LanguageTool and comment suggestions on the PR
        uses: reviewdog/action-languagetool@v1.23.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          level: info
          patterns: "**/*.md **/*.txt **/*.rst **/*.adoc"
          language: ${{ env.LT_LANGUAGE }}
          custom_api_endpoint: "http://127.0.0.1:8010"

      - name: Remove rerun label (so maintainers can trigger again)
        if: github.event.action == 'labeled' && github.event.label.name == 'languagetool:run'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              name: 'languagetool:run',
            });
