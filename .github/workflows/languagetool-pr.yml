name: LanguageTool (reviewdog)

on:
  pull_request_target:
    types: [opened, reopened, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: languagetool-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  languagetool:
    runs-on: ubuntu-latest

    steps:
      - name: Decide whether to run + gather PR info
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;

            async function getPerm(username) {
              const res = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username,
              });
              return res.data.permission; // admin|maintain|write|triage|read|none
            }

            let run = false;
            let prNumber = null;
            let pr = null;

            if (eventName === "pull_request_target") {
              pr = context.payload.pull_request;
              prNumber = pr.number;

              if (context.payload.action === "labeled") {
                run = (context.payload.label?.name === "languagetool:rerun");
              } else {
                // opened / reopened
                run = true;
              }
            } else if (eventName === "issue_comment") {
              // only run for PR comments
              if (!context.payload.issue?.pull_request) {
                run = false;
              } else {
                const body = (context.payload.comment?.body || "").trim();
                const wants = body.startsWith("/languagetool");
                if (!wants) {
                  run = false;
                } else {
                  const perm = await getPerm(context.payload.comment.user.login);
                  run = ["admin", "maintain", "write"].includes(perm);
                }

                prNumber = context.payload.issue.number;
                const prRes = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                });
                pr = prRes.data;
              }
            }

            core.setOutput("run", run ? "true" : "false");
            if (!pr) return;

            core.setOutput("pr_number", String(prNumber));
            core.setOutput("head_sha", pr.head.sha);
            core.setOutput("base_sha", pr.base.sha);
            core.setOutput("head_repo", pr.head.repo.full_name);
            core.setOutput("base_repo", pr.base.repo.full_name);

      - name: Stop early if not requested
        if: steps.meta.outputs.run != 'true'
        run: echo "Not running LanguageTool."

      - name: Checkout PR head (safe)
        if: steps.meta.outputs.run == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.meta.outputs.head_repo }}
          ref: ${{ steps.meta.outputs.head_sha }}
          fetch-depth: 0
          persist-credentials: false
          submodules: false

      - name: Fetch base SHA for diffing
        if: steps.meta.outputs.run == 'true'
        run: |
          set -euo pipefail
          git remote add upstream "https://github.com/${{ steps.meta.outputs.base_repo }}.git" || true
          git fetch --no-tags --depth=1 upstream "${{ steps.meta.outputs.base_sha }}"

      - name: Setup Python
        if: steps.meta.outputs.run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        if: steps.meta.outputs.run == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Setup reviewdog
        if: steps.meta.outputs.run == 'true'
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      - name: Start LanguageTool server
        if: steps.meta.outputs.run == 'true'
        run: |
          set -euo pipefail
          docker run -d --rm --name languagetool -p 8010:8010 erikvl87/languagetool:latest

          # Wait until ready
          for i in $(seq 1 60); do
            if curl -fsS "http://localhost:8010/v2/languages" >/dev/null; then
              echo "LanguageTool is up."
              exit 0
            fi
            sleep 2
          done

          echo "LanguageTool did not become ready in time" >&2
          docker logs languagetool || true
          exit 1

      - name: Run LanguageTool and comment on PR
        if: steps.meta.outputs.run == 'true'
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          python .github/scripts/languagetool_reviewdog.py \
            --api-url "http://localhost:8010/v2/check" \
            --language "en-US" \
            --base-sha "${{ steps.meta.outputs.base_sha }}" \
            --head-sha "${{ steps.meta.outputs.head_sha }}" \
            --dictionary ".languagetool/words.txt" \
          | reviewdog -f=rdjson \
              -name="LanguageTool" \
              -reporter="github-pr-review" \
              -filter-mode="file" \
              -fail-level="none" \
              -level="warning"

      - name: Remove rerun label (so it can be added again later)
        if: steps.meta.outputs.run == 'true' && github.event_name == 'pull_request_target' && github.event.action == 'labeled' && github.event.label.name == 'languagetool:rerun'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              name: "languagetool:rerun",
            });

      - name: Stop LanguageTool
        if: always() && steps.meta.outputs.run == 'true'
        run: docker stop languagetool || true
